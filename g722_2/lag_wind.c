/*------------------------------------------------------------------------*
 *                         AUTOCORR.C                                     *
 *------------------------------------------------------------------------*
 *   Compute autocorrelations of signal with windowing                    *
 *                                                                        *
 *------------------------------------------------------------------------*/

#include "typedef.h"
#include "basic_op.h"
#include "math_op.h"
#include "oper_32b.h"
#include "acelp.h"

/* Hamming_cos window for LPC analysis.                 */
/*   Create with function hamm_cos(window,384-128,128)  */

#define L_WINDOW 384

Word16 window[L_WINDOW] = {
    2621,    2622,    2626,    2632,    2640,    2650,    2662,    2677,
    2694,    2714,    2735,    2759,    2785,    2814,    2844,    2877,
    2912,    2949,    2989,    3031,    3075,    3121,    3169,    3220,
    3273,    3328,    3385,    3444,    3506,    3569,    3635,    3703,
    3773,    3845,    3919,    3996,    4074,    4155,    4237,    4321,
    4408,    4496,    4587,    4680,    4774,    4870,    4969,    5069,
    5171,    5275,    5381,    5489,    5599,    5710,    5824,    5939,
    6056,    6174,    6295,    6417,    6541,    6666,    6793,    6922,
    7052,    7185,    7318,    7453,    7590,    7728,    7868,    8009,
    8152,    8296,    8442,    8589,    8737,    8887,    9038,    9191,
    9344,    9499,    9655,    9813,    9971,   10131,   10292,   10454,
   10617,   10781,   10946,   11113,   11280,   11448,   11617,   11787,
   11958,   12130,   12303,   12476,   12650,   12825,   13001,   13178,
   13355,   13533,   13711,   13890,   14070,   14250,   14431,   14612,
   14793,   14975,   15158,   15341,   15524,   15708,   15891,   16076,
   16260,   16445,   16629,   16814,   16999,   17185,   17370,   17555,
   17740,   17926,   18111,   18296,   18481,   18666,   18851,   19036,
   19221,   19405,   19589,   19773,   19956,   20139,   20322,   20504,
   20686,   20867,   21048,   21229,   21408,   21588,   21767,   21945,
   22122,   22299,   22475,   22651,   22825,   22999,   23172,   23344,
   23516,   23686,   23856,   24025,   24192,   24359,   24525,   24689,
   24853,   25016,   25177,   25337,   25496,   25654,   25811,   25967,
   26121,   26274,   26426,   26576,   26725,   26873,   27019,   27164,
   27308,   27450,   27590,   27729,   27867,   28003,   28137,   28270,
   28401,   28531,   28659,   28785,   28910,   29033,   29154,   29274,
   29391,   29507,   29622,   29734,   29845,   29953,   30060,   30165,
   30268,   30370,   30469,   30566,   30662,   30755,   30847,   30936,
   31024,   31109,   31193,   31274,   31354,   31431,   31506,   31579,
   31651,   31719,   31786,   31851,   31914,   31974,   32032,   32088,
   32142,   32194,   32243,   32291,   32336,   32379,   32419,   32458,
   32494,   32528,   32560,   32589,   32617,   32642,   32664,   32685,
   32703,   32719,   32733,   32744,   32753,   32760,   32764,   32767,
   32767,   32765,   32757,   32745,   32727,   32705,   32678,   32646,
   32609,   32567,   32520,   32468,   32411,   32349,   32283,   32211,
   32135,   32054,   31968,   31877,   31781,   31681,   31575,   31465,
   31351,   31231,   31107,   30978,   30844,   30706,   30563,   30415,
   30263,   30106,   29945,   29779,   29609,   29434,   29255,   29071,
   28883,   28691,   28494,   28293,   28087,   27878,   27664,   27446,
   27224,   26997,   26767,   26533,   26294,   26052,   25806,   25555,
   25301,   25043,   24782,   24516,   24247,   23974,   23698,   23418,
   23134,   22847,   22557,   22263,   21965,   21665,   21361,   21054,
   20743,   20430,   20113,   19794,   19471,   19146,   18817,   18486,
   18152,   17815,   17476,   17134,   16789,   16442,   16092,   15740,
   15385,   15028,   14669,   14308,   13944,   13579,   13211,   12841,
   12470,   12096,   11721,   11344,   10965,   10584,   10202,    9819,
    9433,    9047,    8659,    8270,    7879,    7488,    7095,    6701,
    6306,    5910,    5514,    5116,    4718,    4319,    3919,    3519,
    3118,    2716,    2315,    1913,    1510,    1108,     705,     302};

/*-----------------------------------------------------*
 | Table of lag_window for autocorrelation.            |
 | noise floor = 1.0001   = (0.9999  on r[1] ..r[16])  |
 | Bandwidth expansion = 60 Hz                         |
 | Sampling frequency  = 12800 Hz                      |
 |                                                     |
 | Special double precision format. See "math_op.c"    |
 |                                                     |
 | lag_wind[0] =  1.00000000    (not stored)           |
 | lag_wind[1] =  0.99946642                           |
 | lag_wind[2] =  0.99816680                           |
 | lag_wind[3] =  0.99600452                           |
 | lag_wind[4] =  0.99298513                           |
 | lag_wind[5] =  0.98911655                           |
 | lag_wind[6] =  0.98440880                           |
 | lag_wind[7] =  0.97887397                           |
 | lag_wind[8] =  0.97252619                           |
 | lag_wind[9] =  0.96538186                           |
 | lag_wind[10]=  0.95745903                           |
 | lag_wind[11]=  0.94877797                           |
 | lag_wind[12]=  0.93936038                           |
 | lag_wind[13]=  0.92922986                           |
 | lag_wind[14]=  0.91841155                           |
 | lag_wind[15]=  0.90693212                           |
 | lag_wind[16]=  0.89481968                           |
 ------------------------------------------------------*/

#define M 16

Word32 lag_w[M] = {
      0x7fee8400,
      0x7fc3ee00,
      0x7f7d1380,
      0x7f1a2300,
      0x7e9b5f00,
      0x7e011b80,
      0x7d4bbe00,
      0x7c7bbd00,
      0x7b91a200,
      0x7a8e0480,
      0x79718e80,
      0x783cf600,
      0x76f10100,
      0x758e8280,
      0x74165a00,
      0x72897380
};


void Autocorr(
     Word16 x[],            /* (i)    : Input signal                      */
     Word16 m,              /* (i)    : LPC order                         */
     Word32 r[]             /* (o) Q15: Autocorrelations  (msb)           */
)
{
    Word16 i, j, norm, shift, y[L_WINDOW];
    Word32 L_sum, L_tmp;

    /* calculate energy of signal */

    L_sum = (Word32)16 << 16;         /* sqrt(256), avoid overflow after rounding */
    for (i = 0; i < L_WINDOW; i++)
    {
        y[i] = mult_r(x[i], window[i]); /* Windowing of signal */
        L_tmp = L_mult(y[i], y[i]);
        L_tmp = L_tmp >> 8;
        L_sum = L_add(L_sum, L_tmp);
    }

    /* scale signal to avoid overflow in autocorrelation */

    norm = norm_l0(L_sum);
    shift = sub(4, (norm >> 1));
    if (shift <= 0)
    {
        shift = 0;
        j = 0;
    }
    else
        j = 1 << (shift - 1);
// j for round
    for (i = 0; i < L_WINDOW; i++)
    {
        y[i] = (y[i] + j) >> shift;
    }

    /* Compute and normalize r[0] */

    /* Put in DPF format (see oper_32b) */
    r[0] = Dot_product12(y, y, L_WINDOW, &norm);

    /* Compute r[1] to r[m] */

    for(i = 1; i <= m; i++)
    {
        L_sum = Dot_product(y, y + i, L_WINDOW - i);
        r[i] = L_shl(L_sum, (-norm));
    }
    return;
}

/*---------------------------------------------------------*
 *                         LAG_WIND.C					   *
 *---------------------------------------------------------*
 * Lag_window on autocorrelations.                         *
 *                                                         *
 * r[i] *= lag_wind[i]                                     *
 *                                                         *
 *  r[i] and lag_wind[i] are in special double precision.  *
 *  See "oper_32b.c" for the format                        *
 *---------------------------------------------------------*/

void Lag_window(
     Word32 r_h[]             /* (i/o)   : Autocorrelations  (msb)       */
)
{
    Word16 i;

    for (i = 1; i <= M; i++)
    {
        r_h[i] = Mpy_32x32(r_h[i], lag_w[i - 1]);
    }
    return;
}
